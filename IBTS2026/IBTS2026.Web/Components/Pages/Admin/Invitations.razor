@page "/admin/invitations"
@using IBTS2026.Web.Services.ApiClients
@using IBTS2026.Web.Services.Auth
@using Microsoft.AspNetCore.Authorization
@inject IInvitationApiClient InvitationApi
@inject IAuthService AuthService
@rendermode @(new InteractiveServerRenderMode(prerender: false))

<PageTitle>Manage Invitations - IBTS</PageTitle>

<AuthorizeView Roles="Admin">
    <Authorized>
        <div class="invitations-container">
    <div class="page-header">
        <h1>User Invitations</h1>
        <button class="btn btn-primary" @onclick="ShowInviteModal">
            + Invite New User
        </button>
    </div>

    @if (_errorMessage != null)
    {
        <div class="alert alert-error">@_errorMessage</div>
    }

    @if (_successMessage != null)
    {
        <div class="alert alert-success">@_successMessage</div>
    }

    @if (_isLoading)
    {
        <div class="loading">Loading invitations...</div>
    }
    else if (_invitations.Count == 0)
    {
        <div class="empty-state">
            <p>No invitations found.</p>
            <p>Click "Invite New User" to send an invitation.</p>
        </div>
    }
    else
    {
        <div class="invitations-table-wrapper">
            <table class="invitations-table">
                <thead>
                    <tr>
                        <th>Email</th>
                        <th>Role</th>
                        <th>Status</th>
                        <th>Invited By</th>
                        <th>Created</th>
                        <th>Expires</th>
                        <th>Actions</th>
                    </tr>
                </thead>
                <tbody>
                    @foreach (var invitation in _invitations)
                    {
                        <tr class="@GetRowClass(invitation)">
                            <td>@invitation.Email</td>
                            <td>
                                <span class="role-badge @invitation.Role.ToLower()">@invitation.Role</span>
                            </td>
                            <td>
                                <span class="status-badge @GetStatusClass(invitation)">
                                    @GetStatusText(invitation)
                                </span>
                            </td>
                            <td>@invitation.InvitedByName</td>
                            <td>@invitation.CreatedAt.ToString("MMM dd, yyyy")</td>
                            <td>
                                @if (invitation.IsUsed)
                                {
                                    <span class="text-muted">N/A</span>
                                }
                                else
                                {
                                    @invitation.ExpiresAt.ToString("MMM dd, yyyy HH:mm")
                                }
                            </td>
                            <td>
                                @if (!invitation.IsUsed)
                                {
                                    <button class="btn btn-sm btn-secondary"
                                            @onclick="() => ResendInvitation(invitation.Id)"
                                            disabled="@_isProcessing">
                                        Resend
                                    </button>
                                    <button class="btn btn-sm btn-danger"
                                            @onclick="() => CancelInvitation(invitation.Id)"
                                            disabled="@_isProcessing">
                                        Cancel
                                    </button>
                                }
                                else
                                {
                                    <span class="text-muted">-</span>
                                }
                            </td>
                        </tr>
                    }
                </tbody>
            </table>
        </div>
    }
</div>

@if (_showInviteModal)
{
    <div class="modal-overlay" @onclick="CloseInviteModal">
        <div class="modal-content" @onclick:stopPropagation="true">
            <div class="modal-header">
                <h2>Invite New User</h2>
                <button class="modal-close" @onclick="CloseInviteModal">&times;</button>
            </div>
            <div class="modal-body">
                @if (_modalError != null)
                {
                    <div class="alert alert-error">@_modalError</div>
                }

                <div class="form-group">
                    <label for="email">Email Address</label>
                    <input type="email" id="email" class="form-control"
                           @bind="_inviteEmail" placeholder="user@example.com" />
                </div>

                <div class="form-group">
                    <label for="role">Role</label>
                    <select id="role" class="form-control" @bind="_inviteRole">
                        <option value="User">User</option>
                        <option value="Admin">Admin</option>
                    </select>
                </div>
            </div>
            <div class="modal-footer">
                <button class="btn btn-secondary" @onclick="CloseInviteModal">Cancel</button>
                <button class="btn btn-primary" @onclick="SendInvitation" disabled="@_isSending">
                    @if (_isSending)
                    {
                        <span>Sending...</span>
                    }
                    else
                    {
                        <span>Send Invitation</span>
                    }
                </button>
            </div>
        </div>
    </div>
}
    </Authorized>
    <NotAuthorized>
        <div class="unauthorized-message">
            <h2>Access Denied</h2>
            <p>You do not have permission to access this page. Admin role is required.</p>
            <a href="/" class="btn btn-primary">Return to Home</a>
        </div>
    </NotAuthorized>
</AuthorizeView>

<style>
    .unauthorized-message {
        text-align: center;
        padding: var(--space-8);
        max-width: 600px;
        margin: var(--space-6) auto;
        background: var(--color-bg-primary);
        border-radius: var(--radius-lg);
        box-shadow: var(--shadow-sm);
    }

    .unauthorized-message h2 {
        color: var(--color-error);
        margin-bottom: var(--space-4);
    }

    .unauthorized-message p {
        color: var(--color-text-muted);
        margin-bottom: var(--space-5);
    }

    .invitations-container {
        max-width: 1200px;
        margin: 0 auto;
    }

    .page-header {
        display: flex;
        justify-content: space-between;
        align-items: center;
        margin-bottom: var(--space-5);
    }

    .page-header h1 {
        margin: 0;
    }

    .loading, .empty-state {
        text-align: center;
        padding: var(--space-8);
        color: var(--color-text-muted);
        background: var(--color-bg-primary);
        border-radius: var(--radius-lg);
        box-shadow: var(--shadow-sm);
    }

    .invitations-table-wrapper {
        overflow-x: auto;
        background: var(--color-bg-primary);
        border-radius: var(--radius-lg);
        box-shadow: var(--shadow-sm);
    }

    .invitations-table {
        width: 100%;
        border-collapse: collapse;
    }

    .invitations-table th,
    .invitations-table td {
        padding: var(--space-4);
        text-align: left;
        border-bottom: 1px solid var(--color-border-light);
    }

    .invitations-table th {
        background-color: var(--color-bg-secondary);
        font-weight: var(--font-weight-semibold);
        color: var(--color-text-secondary);
        font-size: var(--font-size-sm);
        text-transform: uppercase;
        letter-spacing: 0.025em;
    }

    .invitations-table tbody tr {
        transition: background-color var(--transition-fast);
    }

    .invitations-table tbody tr:hover {
        background-color: var(--color-bg-secondary);
    }

    .invitations-table tr.used {
        opacity: 0.6;
    }

    .invitations-table tr.expired {
        background-color: var(--color-warning-bg);
    }

    .role-badge {
        display: inline-flex;
        align-items: center;
        padding: var(--space-1) var(--space-3);
        border-radius: var(--radius-full);
        font-size: var(--font-size-xs);
        font-weight: var(--font-weight-semibold);
        text-transform: uppercase;
        letter-spacing: 0.025em;
    }

    .role-badge.admin {
        background-color: rgba(94, 129, 172, 0.15);
        color: var(--color-primary);
    }

    .role-badge.user {
        background-color: var(--color-success-bg);
        color: var(--color-success-text);
    }

    .status-badge {
        display: inline-flex;
        align-items: center;
        padding: var(--space-1) var(--space-3);
        border-radius: var(--radius-full);
        font-size: var(--font-size-xs);
        font-weight: var(--font-weight-semibold);
    }

    .status-badge.pending {
        background-color: var(--color-warning-bg);
        color: var(--color-warning-text);
    }

    .status-badge.used {
        background-color: var(--color-success-bg);
        color: var(--color-success-text);
    }

    .status-badge.expired {
        background-color: var(--color-error-bg);
        color: var(--color-error-text);
    }

    .alert-error {
        background-color: var(--color-error-bg);
        color: var(--color-error-text);
        padding: var(--space-4);
        border-radius: var(--radius-md);
        margin-bottom: var(--space-4);
    }
</style>
